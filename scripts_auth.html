<script>
    // Dépendances: scripts_core.html (showView, showNotification, handleServerError)

    /**
     * Gère la réponse de l'appel initial au serveur (getInitialAppStatus).
     */
    function handleInitialStatus(response) {
        if (response.status === 'ERROR') {
            document.getElementById('login-error').textContent = response.message;
            document.querySelector('.login-card h2').textContent = 'Erreur Critique';
            showView('login-view');
            return;
        }

        // AUTO-LOGIN LOGIC (Gestion du Token URL)
        // La variable globalToken est injectée depuis index.html (qui la reçoit de doGet)
        if (typeof globalToken !== 'undefined' && globalToken) {
            console.log("Token détecté, tentative de connexion auto...");
            tryLogin(globalToken);
            return;
        }

        showView('choice-view');

        // Gérer l'affichage des boutons Setup/Login
        if (response.setupNeeded) {
            elements.setupButton.classList.add('btn-primary');
            elements.setupButton.classList.remove('btn-secondary');
            elements.loginButton.classList.add('btn-secondary');
            elements.loginButton.classList.remove('btn-primary');
        } else {
            elements.setupButton.classList.add('btn-secondary');
            elements.setupButton.classList.remove('btn-primary');
            elements.loginButton.classList.add('btn-primary');
            elements.loginButton.classList.remove('btn-secondary');
        }
    }

    /**
     * Tente d'authentifier l'utilisateur via google.script.run
     * @param {string} token (Optionnel) Token d'accès collaborateur
     */
    function tryLogin(token = null) {
        elements.choiceErrorEl.classList.add('hidden');
        showView('loading-view');

        google.script.run
            .withSuccessHandler(handleLoginSuccess)
            .withFailureHandler(function (err) {
                handleServerError(err);
                if (token) showView('choice-view'); // Revenir si échec token
            })
            .authenticateUser(token);
    }

    /**
     * Gère la réponse de l'authentification.
     */
    function handleLoginSuccess(response) {
        if (response.status === 'OK') {
            // Stocker l'utilisateur globalement
            currentUser = response.user;

            // Router vers la bonne vue
            if (response.route === 'MANAGER_VIEW') {
                initManagerView();
                showView('manager-view');
            } else if (response.route === 'COLLABORATOR_VIEW') {
                initCollaboratorView();
                showView('collaborator-view');
            }
        } else {
            // Afficher l'erreur
            elements.choiceErrorEl.textContent = response.message || "Utilisateur non trouvé.";
            elements.choiceErrorEl.classList.remove('hidden');
            showView('choice-view');
        }
    }

    /**
     * Gère la soumission du formulaire de configuration initiale.
     */
    function handleSetupSubmit(e) {
        e.preventDefault();

        const setupSubmitBtn = document.getElementById('setup-submit-btn');
        setupSubmitBtn.disabled = true;
        elements.setupErrorEl.classList.add('hidden');

        const form = e.target;
        const data = {
            matricule: form.matricule.value,
            nom: form.nom.value,
            prenom: form.prenom.value,
            codeCentre: form.codeCentre.value,
            heureDebut: form.heureDebut.value,
            heureFin: form.heureFin.value,
            dureePause: form.dureePause.value
        };

        google.script.run
            .withSuccessHandler(function (response) {
                setupSubmitBtn.disabled = false;
                if (response.status === 'SUCCESS') {
                    showNotification(response.message, 'success');
                    // Tenter la connexion immédiatement après le setup
                    tryLogin();
                } else {
                    elements.setupErrorEl.textContent = response.message;
                    elements.setupErrorEl.classList.remove('hidden');
                }
            })
            .withFailureHandler(function (error) {
                setupSubmitBtn.disabled = false;
                elements.setupErrorEl.textContent = "Erreur serveur: " + error.message;
                elements.setupErrorEl.classList.remove('hidden');
            })
            .completeSetup(data);
    }
</script>