<script>
    // Global State
    let currentUser = null;

    // DOM Elements
    const views = {
        'loading-view': document.getElementById('loading-view'),
        'login-view': document.getElementById('login-view'),
        'choice-view': document.getElementById('choice-view'),
        'setup-view': document.getElementById('setup-view'),
        'collaborator-view': document.getElementById('collaborator-view'),
        'manager-view': document.getElementById('manager-view')
    };

    const elements = {
        notificationContainer: document.getElementById('notification-container'),
        rejectionModal: document.getElementById('rejection-modal'),
        rejectionForm: document.getElementById('rejection-form'),
        rejectionSubmitBtn: document.getElementById('rejection-submit-btn'),

        setupForm: document.getElementById('setup-form'),
        setupSubmitBtn: document.getElementById('setup-submit-btn'),
        setupErrorEl: document.getElementById('setup-error'),

        loginButton: document.getElementById('login-button'),
        setupButton: document.getElementById('setup-button'),
        choiceErrorEl: document.getElementById('choice-error')
    };

    // Initialization
    document.addEventListener('DOMContentLoaded', function () {
        showView('loading-view');

        google.script.run
            .withSuccessHandler(handleInitialStatus)
            .withFailureHandler(handleServerError)
            .getInitialAppStatus();

        elements.rejectionForm.addEventListener('submit', handleRejectionSubmit);
        elements.setupForm.addEventListener('submit', handleSetupSubmit);
    });

    // =========================================================================
    // GLOBAL UX/NAVIGATION
    // =========================================================================

    function showView(viewName) {
        Object.values(views).forEach(el => {
            if (el) el.classList.add('hidden');
        });
        if (views[viewName]) {
            views[viewName].classList.remove('hidden');
        } else {
            console.error("Vue non trouvée:", viewName);
        }
    }

    function showNotification(message, type = 'info') {
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;

        elements.notificationContainer.appendChild(notif);

        setTimeout(() => {
            if (notif && notif.parentNode) {
                notif.parentNode.removeChild(notif);
            }
        }, 5000);
    }

    function showRejectionModal(rowId) {
        document.getElementById('rejection-entry-id').value = rowId;
        document.getElementById('rejection-reason').value = '';
        elements.rejectionModal.classList.remove('hidden');
        elements.rejectionSubmitBtn.disabled = false;
    }

    function hideRejectionModal() {
        elements.rejectionModal.classList.add('hidden');
    }

    function handleServerError(error) {
        showView('login-view');
        const errorEl = document.getElementById('login-error');
        errorEl.textContent = "Erreur de connexion au serveur. Veuillez réessayer ou vérifier votre déploiement. Détail: " + error.message;
        errorEl.classList.remove('hidden');
    }

    /**
     * Gère la déconnexion côté client et le retour à l'écran de choix.
     */
    function handleDisconnect() {
        if (confirm('Voulez-vous vraiment vous déconnecter?')) {
            currentUser = null;

            google.script.run
                .withSuccessHandler(handleInitialStatus)
                .withFailureHandler(handleServerError)
                .getInitialAppStatus();
        }
    }

    /**
     * Charge l'ID et le lien de la feuille de calcul générée.
     */
    function loadSpreadsheetInfo() {
        google.script.run
            .withSuccessHandler(function (info) {
                const linkHtml = `<a href="${info.url}" target="_blank">${info.id}</a>`;

                // Manager
                const managerLinkEl = document.getElementById('bdd-link-manager');
                if (managerLinkEl) {
                    managerLinkEl.innerHTML = linkHtml;
                }

                // Collaborateur (peut être caché)
                const collabLinkEl = document.getElementById('bdd-link-collaborator');
                if (collabLinkEl) {
                    collabLinkEl.innerHTML = linkHtml;
                }
            })
            .withFailureHandler(function (error) {
                showNotification("Erreur lors du chargement de l'ID BDD.", 'error');
            })
            .getSpreadsheetInfo();
    }


    // =========================================================================
    // AUTHENTICATION & INITIAL ROUTING
    // =========================================================================

    function handleInitialStatus(response) {
        if (response.status === 'ERROR') {
            document.getElementById('login-error').textContent = response.message;
            document.querySelector('.login-card h2').textContent = 'Erreur Critique';
            showView('login-view');
            return;
        }

        showView('choice-view');

        if (response.setupNeeded) {
            elements.setupButton.classList.add('btn-primary');
            elements.setupButton.classList.remove('btn-secondary');
            elements.loginButton.classList.add('btn-secondary');
            elements.loginButton.classList.remove('btn-primary');
        } else {
            elements.setupButton.classList.add('btn-secondary');
            elements.setupButton.classList.remove('btn-primary');
            elements.loginButton.classList.add('btn-primary');
            elements.loginButton.classList.remove('btn-secondary');
        }
    }

    function tryLogin() {
        elements.choiceErrorEl.classList.add('hidden');
        showView('loading-view');

        google.script.run
            .withSuccessHandler(handleLoginSuccess)
            .withFailureHandler(handleServerError)
            .authenticateUser();
    }

    function handleLoginSuccess(response) {
        if (response.status === 'OK') {
            currentUser = response.user;

            if (response.route === 'MANAGER_VIEW') {
                initManagerView();
                showView('manager-view');
            } else if (response.route === 'COLLABORATOR_VIEW') {
                initCollaboratorView();
                showView('collaborator-view');
            }
        } else if (response.route === 'NOT_FOUND') {
            elements.choiceErrorEl.textContent = response.message;
            elements.choiceErrorEl.classList.remove('hidden');
            showView('choice-view');
        }
    }

    // =========================================================================
    // SETUP LOGIC
    // =========================================================================

    function handleSetupSubmit(e) {
        e.preventDefault();

        elements.setupSubmitBtn.disabled = true;
        elements.setupErrorEl.classList.add('hidden');

        const form = e.target;
        const data = {
            matricule: form.matricule.value,
            nom: form.nom.value,
            prenom: form.prenom.value,
            codeCentre: form.codeCentre.value,
            heureDebut: form.heureDebut.value,
            heureFin: form.heureFin.value,
            dureePause: form.dureePause.value
        };

        google.script.run
            .withSuccessHandler(function (response) {
                elements.setupSubmitBtn.disabled = false;
                if (response.status === 'SUCCESS') {
                    showNotification(response.message, 'success');
                    tryLogin();
                } else {
                    elements.setupErrorEl.textContent = response.message;
                    elements.setupErrorEl.classList.remove('hidden');
                }
            })
            .withFailureHandler(function (error) {
                elements.setupSubmitBtn.disabled = false;
                elements.setupErrorEl.textContent = "Erreur serveur: " + error.message;
                elements.setupErrorEl.classList.remove('hidden');
            })
            .completeSetup(data);
    }


    // =========================================================================
    // COLLABORATOR LOGIC
    // =========================================================================

    function initCollaboratorView() {
        document.getElementById('collab-name').textContent = currentUser.prenom + ' ' + currentUser.nom;
        document.getElementById('collab-matricule-hidden').value = currentUser.matricule;
        document.getElementById('collab-nom-hidden').value = currentUser.nom;
        document.getElementById('collab-prenom-hidden').value = currentUser.prenom;
        document.getElementById('collab-code-centre-hidden').value = currentUser.code_centre;

        loadHistory();

        const form = document.getElementById('overtime-form');
        form.removeEventListener('submit', handleOvertimeSubmit);
        form.addEventListener('submit', handleOvertimeSubmit);

        loadSpreadsheetInfo();
    }

    function handleOvertimeSubmit(e) {
        e.preventDefault();

        const form = e.target;
        const submitBtn = document.getElementById('overtime-submit-btn');
        submitBtn.disabled = true;

        const hours = parseInt(form.hours.value, 10) || 0;
        const minutes = parseInt(form.minutes.value, 10) || 0;

        const overtimeData = {
            matricule: form.matricule.value,
            nom: form.nom.value,
            prenom: form.prenom.value,
            codeCentre: form.codeCentre.value,
            date: form.date.value,
            hours: hours,
            minutes: minutes,
            description: form.description.value
        };

        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    showNotification(result.message, 'success');
                    form.reset();
                    loadHistory();
                } else {
                    showNotification("Erreur de soumission: " + result.error, 'error');
                }
                submitBtn.disabled = false;
            })
            .withFailureHandler(function (error) {
                showNotification("Erreur serveur lors de la soumission: " + error, 'error');
                submitBtn.disabled = false;
            })
            .logOvertimeEntry(overtimeData);
    }

    function loadHistory() {
        const tbody = document.getElementById('history-list-body');
        tbody.innerHTML = '<tr><td colspan="5">Chargement de l\'historique...</td></tr>';

        google.script.run
            .withSuccessHandler(function (history) {
                tbody.innerHTML = '';
                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">Aucune saisie trouvée.</td></tr>';
                    return;
                }

                history.forEach(item => {
                    const date = new Date(item.date_supp).toLocaleDateString('fr-FR');
                    const statusClass = item.status.toLowerCase().replace('_', '-');
                    const row = document.createElement('tr');

                    let actionsHtml = '';
                    if (item.status === 'EN_ATTENTE') {
                        actionsHtml = `<button onclick="confirmCancelEntry(${item.row_id})" class="btn-secondary" style="background-color: var(--error-color); width: auto; padding: 5px 10px;">Annuler</button>`;
                    } else if (item.status === 'REJETE' && item.rejectionReason) {
                        actionsHtml = `<button onclick="showNotification('Motif de rejet: ${item.rejectionReason.replace(/'/g, '\\\'')}', 'info')" class="btn-secondary" style="width: auto; padding: 5px 10px;">Voir Motif</button>`;
                    }

                    const displayStatus = item.status.replace('_', ' ');

                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${item.hours}h ${item.minutes}min</td>
                        <td>${item.description}</td>
                        <td><span class="status-badge status-${statusClass}">${displayStatus}</span></td>
                        <td>${actionsHtml}</td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .withFailureHandler(function (error) {
                tbody.innerHTML = `<tr><td colspan="5" class="error-message">Erreur de chargement: ${error}</td></tr>`;
            })
            .getHistory(currentUser.matricule);
    }

    function confirmCancelEntry(rowId) {
        if (confirm('Êtes-vous sûr de vouloir annuler cette saisie d\'heures supplémentaires ? Cette action est irréversible.')) {
            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.success) {
                        showNotification(result.message, 'success');
                        loadHistory();
                    } else {
                        showNotification(result.error, 'error');
                    }
                })
                .withFailureHandler(function (error) {
                    showNotification("Erreur serveur lors de l'annulation: " + error, 'error');
                })
                .cancelOvertimeEntry(rowId);
        }
    }

    // =========================================================================
    // MANAGER LOGIC
    // =========================================================================

    function initManagerView() {
        document.getElementById('manager-name').textContent = currentUser.prenom + ' ' + currentUser.nom;
        document.getElementById('manager-centre-code').textContent = currentUser.code_centre;
        loadPendingApprovals();

        setupCollaboratorForm();
        loadCollaborators();
        loadSpreadsheetInfo();
    }

    function loadPendingApprovals() {
        const list = document.getElementById('approvals-list');
        list.innerHTML = '<p>Chargement des demandes de votre centre...</p>';

        google.script.run
            .withSuccessHandler(function (approvals) {
                list.innerHTML = '';
                if (approvals.length === 0) {
                    list.innerHTML = '<p>Aucune demande de validation en attente pour votre centre.</p>';
                    return;
                }

                approvals.forEach(item => {
                    const date = new Date(item.date_supp).toLocaleDateString('fr-FR');
                    const approvalItem = document.createElement('div');
                    approvalItem.className = 'approval-item';
                    approvalItem.innerHTML = `
                        <p><strong>${item.prenom} ${item.nom}</strong> (${item.matricule}) - ${item.hours}h ${item.minutes}min</p>
                        <p>Date: ${date} | Description: ${item.description}</p>
                        <div>
                            <button onclick="handleApprovalAction(${item.row_id}, 'APPROVE')" class="btn-primary" style="background-color: var(--success-color);">Approuver</button>
                            <button onclick="handleApprovalAction(${item.row_id}, 'REJECT')" class="btn-secondary" style="background-color: var(--error-color);">Rejeter</button>
                        </div>
                    `;
                    list.appendChild(approvalItem);
                });
            })
            .withFailureHandler(function (error) {
                list.innerHTML = `<p class="error-message">Erreur de chargement: ${error}</p>`;
            })
            .getApprovals(currentUser.code_centre);
    }

    function handleApprovalAction(rowId, action) {
        if (action === 'REJECT') {
            showRejectionModal(rowId);
        } else if (action === 'APPROVE') {
            if (confirm('Confirmez-vous l\'approbation de cette demande ?')) {
                processValidation(rowId, 'APPROVE', '');
            }
        }
    }

    function handleRejectionSubmit(e) {
        e.preventDefault();

        elements.rejectionSubmitBtn.disabled = true;

        const form = e.target;
        const reason = form.reason.value.trim();
        const rowId = parseInt(form.entryId.value, 10);

        if (reason) {
            processValidation(rowId, 'REJECT', reason);
        } else {
            showNotification('Le motif de rejet ne peut pas être vide.', 'error');
            elements.rejectionSubmitBtn.disabled = false;
        }
    }

    function processValidation(rowId, action, reason) {
        const managerMatricule = currentUser.matricule;

        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    showNotification(result.message, 'success');
                    loadPendingApprovals();
                    hideRejectionModal();
                } else {
                    showNotification("Erreur de validation: " + result.error, 'error');
                }
                elements.rejectionSubmitBtn.disabled = false;
            })
            .withFailureHandler(function (error) {
                showNotification("Erreur serveur lors de la validation: " + error, 'error');
                elements.rejectionSubmitBtn.disabled = false;
            })
            .handleApproval(rowId, action, managerMatricule, reason);
    }

    // =========================================================================
    // CRUD Collaborators Logic (Manager)
    // =========================================================================

    function setupCollaboratorForm() {
        const formContainer = document.getElementById('collab-form-container');
        const form = document.getElementById('collaborator-form');
        const showBtn = document.getElementById('show-collab-form-btn');
        const cancelBtn = document.getElementById('cancel-collab-form-btn');

        showBtn.addEventListener('click', () => {
            resetCollabForm();
            formContainer.classList.remove('hidden');
        });

        cancelBtn.addEventListener('click', () => {
            formContainer.classList.add('hidden');
        });

        form.removeEventListener('submit', handleCollabSubmit);
        form.addEventListener('submit', handleCollabSubmit);
    }

    function loadCollaborators() {
        const tbody = document.getElementById('collaborators-list-body');
        tbody.innerHTML = '<tr><td colspan="6">Chargement des collaborateurs...</td></tr>';

        google.script.run
            .withSuccessHandler(function (list) {
                tbody.innerHTML = '';
                if (list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">Aucun collaborateur trouvé.</td></tr>';
                    return;
                }

                list.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.matricule}</td>
                        <td>${item.prenom} ${item.nom}</td>
                        <td>${item.email}</td>
                        <td>${item.code_centre}</td>
                        <td>${item.role}</td>
                        <td>
                            <button onclick="editCollaborator('${item.matricule}')" class="btn-secondary" style="margin-right: 5px; width: auto; padding: 5px 10px;">Editer</button>
                            <button onclick="deleteCollaboratorPrompt('${item.matricule}')" class="btn-secondary" style="background-color: var(--error-color); width: auto; padding: 5px 10px;">Supprimer</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .withFailureHandler(function (error) {
                tbody.innerHTML = `<tr><td colspan="6" class="error-message">Erreur de chargement: ${error}</td></tr>`;
            })
            .getAllCollaboratorsController();
    }

    function handleCollabSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const action = form.action.value;
        const errorEl = document.getElementById('collab-form-error');
        errorEl.classList.add('hidden');

        const submitBtn = document.getElementById('collab-submit-btn');
        submitBtn.disabled = true;

        const collabData = {
            matricule: form.matricule.value,
            nom: form.nom.value,
            prenom: form.prenom.value,
            email: form.email.value,
            code_centre: form.code_centre.value,
            role: form.role.value
        };

        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    showNotification('Collaborateur ' + (action === 'CREATE' ? 'créé' : 'mis à jour') + ' avec succès !', 'success');
                    resetCollabForm();
                    document.getElementById('collab-form-container').classList.add('hidden');
                    loadCollaborators();
                } else {
                    errorEl.textContent = result.error;
                    errorEl.classList.remove('hidden');
                }
                submitBtn.disabled = false;
            })
            .withFailureHandler(function (error) {
                errorEl.textContent = "Erreur du serveur: " + error;
                errorEl.classList.remove('hidden');
                submitBtn.disabled = false;
            })
            .manageCollaborator(action, collabData);
    }

    function editCollaborator(matricule) {
        google.script.run
            .withSuccessHandler(function (list) {
                const collab = list.find(c => c.matricule == matricule);
                if (!collab) {
                    showNotification('Erreur: Collaborateur non trouvé.', 'error');
                    return;
                }

                const form = document.getElementById('collaborator-form');
                document.getElementById('collab-form-title').textContent = 'Modifier';
                document.getElementById('collab-form-action').value = 'UPDATE';
                document.getElementById('collab-submit-btn').textContent = 'Mettre à jour';

                const matriculeInput = document.getElementById('collab-matricule');
                matriculeInput.readOnly = true;
                matriculeInput.style.backgroundColor = '#f0f0f0';

                form.matricule.value = collab.matricule;
                form.nom.value = collab.nom;
                form.prenom.value = collab.prenom;
                form.email.value = collab.email;
                form.code_centre.value = collab.code_centre;
                form.role.value = collab.role;

                document.getElementById('collab-form-container').classList.remove('hidden');
            })
            .getAllCollaboratorsController();
    }

    function deleteCollaboratorPrompt(matricule) {
        if (confirm('Êtes-vous sûr de vouloir supprimer le collaborateur avec le matricule ' + matricule + ' ? Cette action est IRRÉVERSIBLE et supprime l\'accès à l\'application.')) {
            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.success) {
                        showNotification('Collaborateur supprimé avec succès !', 'success');
                        loadCollaborators();
                    } else {
                        showNotification('Erreur lors de la suppression: ' + result.error, 'error');
                    }
                })
                .withFailureHandler(function (error) {
                    showNotification("Erreur serveur lors de la suppression: " + error, 'error');
                })
                .manageCollaborator('DELETE', { matricule: matricule });
        }
    }

    function resetCollabForm() {
        const form = document.getElementById('collaborator-form');
        form.reset();
        document.getElementById('collab-form-title').textContent = 'Ajouter';
        document.getElementById('collab-form-action').value = 'CREATE';
        document.getElementById('collab-submit-btn').textContent = 'Créer';

        const matriculeInput = document.getElementById('collab-matricule');
        matriculeInput.readOnly = false;
        matriculeInput.style.backgroundColor = '';

        document.getElementById('collab-form-error').classList.add('hidden');
    }
</script>